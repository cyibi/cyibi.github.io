<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>章別タイピングゲーム</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 30px; background: #f2f2f2; }
    #chapter { font-size: 1.5em; margin-bottom: 10px; }
    #word { font-size: 2em; margin: 20px; color: #333; }
    #input { font-size: 1.2em; padding: 8px; width: 80%; max-width: 400px; }
    #result, #timer { margin-top: 20px; font-weight: bold; }
    #startBtn, #nextBtn, #retryBtn, #quitBtn {
      padding: 10px 20px; font-size: 1em; margin: 10px auto; display: block;
    }
    #nextBtn, #retryBtn, #quitBtn { display: none; }
    #retryBtn { background: orange; color: white; border: none; border-radius: 5px; }
    #quitBtn { background: #999; color: white; border: none; border-radius: 5px; }
    #ranking { margin-top: 30px; text-align: left; display: inline-block; background: #fff; padding: 10px; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 6px 10px; border-bottom: 1px solid #ccc; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>
</head>
<body>
  <h1>章別タイピングゲーム</h1>
  <div id="chapter"></div>
  <div id="word">章を開始するにはボタンを押してください</div>
  <input type="text" id="input" placeholder="ここにタイピング" disabled />
  <button id="startBtn">第1章 スタート</button>
  <button id="nextBtn">次の章へ進む</button>
  <button id="retryBtn">もう一度チャレンジ</button>
  <button id="quitBtn">ゲームをやめる</button>
  <div id="result"></div>
  <div id="timer">残り時間: --秒</div>

  <div id="ranking">
    <h2>ランキング</h2>
    <table id="rankingTable">
      <tr><th>名前</th><th>ミス</th><th>章</th></tr>
    </table>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDZ-vGSqDmhUhCNDVqE4dk5nidqz_YufaY",
      authDomain: "cyibi-typing-game.firebaseapp.com",
      databaseURL: "https://cyibi-typing-game-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "cyibi-typing-game",
      storageBucket: "cyibi-typing-game.firebasestorage.app",
      messagingSenderId: "282981966176",
      appId: "1:282981966176:web:0590d0b2c1a0199efa7e05"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const chapters = [
      { name: "第1章", words: ["cat","dog","sun","tree","book","car","pen","fish","home","milk"], maxMiss: 2 },
      { name: "第2章", words: ["window","purple","banana","coffee","guitar","planet","silver","yellow","butter","bridge"], maxMiss: 3 },
      { name: "第3章", words: ["elephant","mountains","adventure","developer","education","beautiful","javascript","direction","chocolate","performance"], maxMiss: 2 }
    ];

    let currentChapter = 0, currentWord = "", count = 0, misses = 0, startTime, timerId;
    const inputEl = document.getElementById("input");
    const wordEl = document.getElementById("word");
    const resultEl = document.getElementById("result");
    const chapterEl = document.getElementById("chapter");
    const timerEl = document.getElementById("timer");
    const startBtn = document.getElementById("startBtn");
    const nextBtn = document.getElementById("nextBtn");
    const retryBtn = document.getElementById("retryBtn");
    const quitBtn = document.getElementById("quitBtn");
    const table = document.getElementById("rankingTable");

    function startChapter() {
      [startBtn, nextBtn, retryBtn, quitBtn].forEach(btn => btn.style.display = "none");
      inputEl.disabled = false;
      inputEl.focus();
      count = 0;
      misses = 0;
      startTime = Date.now();
      updateTimer();
      timerId = setInterval(updateTimer, 1000);
      nextWord();
    }

    function updateTimer() {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const remaining = 60 - elapsed;
      timerEl.textContent = "残り時間: " + remaining + "秒";
      if (remaining <= 0 || count >= 10) {
        clearInterval(timerId);
        inputEl.disabled = true;
        const chapter = chapters[currentChapter];
        if (misses > chapter.maxMiss) {
          resultEl.textContent = `失敗… ミス: ${misses}回（許容 ${chapter.maxMiss}回まで）`;
          wordEl.textContent = "リトライか、ゲームを終了できます";
          retryBtn.style.display = "inline-block";
          quitBtn.style.display = "inline-block";
          return;
        }
        const rank = getRank(misses);
        resultEl.innerHTML = `クリア！ ミス: ${misses}回 - ランク: ${rank}`;
        const name = prompt("名前を入力してください（匿名OK）:");
        if (name) db.ref("ranking").push({ name, misses, chapter: chapter.name });
        if (currentChapter < chapters.length - 1) {
          nextBtn.style.display = "block";
        } else {
          wordEl.textContent = "全章クリア！お疲れ様！";
          timerEl.textContent = "";
        }
        loadRanking();
      }
    }

    function getRank(miss) {
      if (miss === 0) return "S";
      if (miss <= 2) return "A";
      if (miss <= 4) return "B";
      if (miss <= 6) return "C";
      return "D";
    }

    function nextWord() {
      const chapter = chapters[currentChapter];
      currentWord = chapter.words[Math.floor(Math.random() * chapter.words.length)];
      wordEl.textContent = currentWord;
      inputEl.value = "";
      resultEl.textContent = "";
    }

    inputEl.addEventListener("input", () => {
      if (inputEl.value === currentWord) {
        count++;
        nextWord();
      } else if (!currentWord.startsWith(inputEl.value)) {
        misses++;
      }
    });

    startBtn.addEventListener("click", () => {
      chapterEl.textContent = chapters[currentChapter].name;
      startChapter();
    });

    nextBtn.addEventListener("click", () => {
      currentChapter++;
      chapterEl.textContent = chapters[currentChapter].name;
      startBtn.textContent = `${chapters[currentChapter].name} スタート`;
      startBtn.style.display = "block";
      wordEl.textContent = "章を開始するにはボタンを押してください";
      resultEl.textContent = "";
    });

    retryBtn.addEventListener("click", () => {
      startBtn.textContent = `${chapters[currentChapter].name} スタート`;
      startBtn.style.display = "block";
      resultEl.textContent = "";
      wordEl.textContent = "再チャレンジできます";
      retryBtn.style.display = "none";
      quitBtn.style.display = "none";
    });

    quitBtn.addEventListener("click", () => location.reload());

    function loadRanking() {
      table.innerHTML = "<tr><th>名前</th><th>
